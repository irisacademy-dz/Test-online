<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Previous head content remains the same -->
    <!-- Add this new style for PDF printing -->
    <style>
        @media print {
            body {
                background-color: white;
                color: black;
            }
            .hidden {
                display: block !important;
            }
            #results-section, .score-card {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
            }
            .print-btn, .navigation, .test-info, .red-remark {
                display: none !important;
            }
            .score-card {
                page-break-after: avoid;
                page-break-inside: avoid;
            }
        }

        /* Add this for better PDF rendering */
        .pdf-header {
            display: none;
        }

        @media print {
            .pdf-header {
                display: block;
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid var(--primary);
                padding-bottom: 10px;
            }
            .pdf-header img {
                height: 60px;
            }
            .pdf-header h2 {
                margin: 5px 0;
                color: var(--primary);
            }
        }
    </style>
</head>
<body>
    <!-- Previous body content remains the same until the results section -->
    
    <div id="results-section" class="hidden">
        <div class="results-container">
            <div class="pdf-header">
                <img src="https://via.placeholder.com/150x50?text=IRIS" alt="IRIS Language Academy Logo">
                <h2>English Proficiency Test Report</h2>
                <p>Cambridge-Standard Assessment</p>
            </div>
            
            <!-- Rest of the results section content remains the same -->
        </div>
    </div>

    <script>
        // Previous JavaScript remains the same until the calculateScores function

        // Enhanced writing test answers with multiple acceptable options
        const writingCorrectAnswers = {
            'writing-q1': ['am', 'i am'],
            'writing-q2': ['was'],
            'writing-q3': ['haven\'t visited', 'have not visited', 'haven\'t seen', 'have not seen'],
            'writing-q4': ['is said', 'is considered', 'is believed'],
            'writing-q5': ['a brilliant speaker is she that', 'a brilliant speaker is she who', 'a brilliant speaker is she whom']
        };

        // Enhanced writing scoring function
        function scoreWritingAnswer(questionId, answer) {
            answer = answer.trim().toLowerCase();
            const correctOptions = writingCorrectAnswers[questionId];
            
            // Check for exact matches
            if (correctOptions.includes(answer)) {
                return 1; // Full credit
            }
            
            // Check for partial matches with minor errors
            for (const option of correctOptions) {
                if (answer.includes(option) || option.includes(answer)) {
                    return 0.5; // Partial credit
                }
                
                // Check for answers with just extra spaces
                if (answer.replace(/\s+/g, ' ') === option.replace(/\s+/g, ' ')) {
                    return 1;
                }
            }
            
            return 0; // No credit
        }

        // Updated calculateScores function
        function calculateScores() {
            // Calculate reading score (same as before)
            readingScore = 0;
            const readingQuestions = document.querySelectorAll('#reading-section [data-question-type]');
            readingQuestions.forEach(question => {
                const correctAnswer = question.getAttribute('data-correct-answer');
                const selectedOption = question.querySelector(`input[type="radio"]:checked`);

                if (selectedOption && selectedOption.value === correctAnswer) {
                    readingScore += 1;
                }
            });

            // Calculate writing score with enhanced scoring
            writingScore = 0;
            writingQuestionInputs.forEach(input => {
                const questionId = input.id;
                const userAnswer = input.value.trim();
                
                if (userAnswer) {
                    writingScore += scoreWritingAnswer(questionId, userAnswer);
                }
            });

            // Rest of the calculateScores function remains the same
            // ...
        }

        // Enhanced PDF generation function
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            
            // Create a temporary div for PDF content
            const pdfContent = document.createElement('div');
            pdfContent.style.width = '210mm';
            pdfContent.style.padding = '20px';
            pdfContent.style.backgroundColor = 'white';
            
            // Clone the score card and add PDF-specific styling
            const scoreCard = document.getElementById('score-card').cloneNode(true);
            
            // Add PDF header
            const pdfHeader = document.createElement('div');
            pdfHeader.className = 'pdf-header';
            pdfHeader.innerHTML = `
                <img src="https://via.placeholder.com/150x50?text=IRIS" alt="IRIS Logo" style="height:50px">
                <h2 style="color: #006f8d; margin: 10px 0 5px 0;">English Proficiency Test Report</h2>
                <p style="margin: 0 0 20px 0;">Cambridge-Standard Assessment</p>
                <hr style="border: 1px solid #006f8d; margin-bottom: 20px;">
            `;
            
            // Add footer
            const pdfFooter = document.createElement('div');
            pdfFooter.style.marginTop = '20px';
            pdfFooter.style.fontSize = '10px';
            pdfFooter.style.textAlign = 'center';
            pdfFooter.style.color = '#666';
            pdfFooter.innerHTML = `
                <hr style="border: 1px solid #ddd; margin: 20px 0 10px 0;">
                <p>IRIS Language Academy - ${new Date().toLocaleDateString()}</p>
                <p>This report is generated automatically. Official results may vary after speaking assessment.</p>
            `;
            
            // Assemble the PDF content
            pdfContent.appendChild(pdfHeader);
            pdfContent.appendChild(scoreCard);
            pdfContent.appendChild(pdfFooter);
            
            // Add to body temporarily
            document.body.appendChild(pdfContent);
            
            // Generate PDF
            html2canvas(pdfContent, {
                scale: 2,
                logging: false,
                useCORS: true,
                scrollX: 0,
                scrollY: 0,
                windowWidth: pdfContent.scrollWidth,
                windowHeight: pdfContent.scrollHeight
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; // A4 width in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                // Generate filename
                const name = fullNameEnInput.value.trim() || 'Participant';
                const safeName = name.replace(/[^a-zA-Z0-9]/g, '_');
                pdf.save(`IRIS_English_Test_${safeName}.pdf`);
                
                // Clean up
                document.body.removeChild(pdfContent);
            }).catch(error => {
                console.error('Error generating PDF:', error);
                document.body.removeChild(pdfContent);
                alert('Error generating PDF. Please try again or contact support.');
            });
        }

        // Rest of the JavaScript remains the same
    </script>
</body>
</html>
